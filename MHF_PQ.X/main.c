
/*!
* \file main.c
* \brief Main Source file
 *
*  * Selects internal oscillator with no switching
*  * Disables clock switching and selects pri osc of HS with OSCIO clock output
*  * Turns off JTAG and selects debug channel
*  *
* \author Adriano Ruseler
* \version 1.0
* \copyright The MIT License (MIT).
*/




/******************************************************************************/
/* Files to Include                                                           */
/******************************************************************************/

/* Device header file */
#if defined(__dsPIC33E__)
	#include <p33Exxxx.h>
#elif defined(__dsPIC33F__)
	#include <p33Fxxxx.h>
#endif

#include <stdint.h>        /* Includes uint16_t definition                    */
#include <stdbool.h>       /* Includes true/false definition                  */
#include <libq.h>           /* include fixed point library */
#include <limits.h>         /* IMPLEMENTATION-DEFINED LIMITS */
#include <math.h>


#include "system.h"        /* System funct/params, like osc/peripheral config */
#include "initialization.h"          /* User funct/params, such as InitApp    */
#include "eCAN.h"



/******************************************************************************/
/* Global Variable Declaration                                                */
/******************************************************************************/
unsigned int Count;
unsigned int TableIndex=665; // Indice da tabela Look-Up Table
unsigned int TableIndexL=0x00; // Indice da tabela Look-Up Table
int DutyCycleQ15=16384; /* 16384 = 0.5 */  //0.775 -> 311/400*2^15
int MasterDutyCycleQ15 =0;
int MasterDutyCycle =0;
unsigned int GpwmQ15 = GpwmVal; /* PWMpico/2 */
int rho=0; // Fator que pondera a raz�o ciclica de cada inversor
int rho_d=0;
int Vsin=0; /* Para Testes apenas */
unsigned int status=0; // Define o status do sistema
unsigned int statusH=0; // status<<10;
unsigned int StatusAction=0x00; // Action from status send by slave
unsigned int StatusActionH=0x00; // Action from status send by slave << 10
int errorFlag =1;

/* i.e. uint16_t <variable_name>; */

mID canTxMessage;
mID canRxMessage;

/* Define ECAN Message Buffers */
#ifdef _HAS_DMA_
ECAN1MSGBUF ecan1msgBuf __attribute__((space(dma),aligned(ECAN1_MSG_BUF_LENGTH*16)));
#else
ECAN1MSGBUF ecan1msgBuf __attribute__((space(xmemory),aligned(ECAN1_MSG_BUF_LENGTH*16)));
#endif


#ifdef _HAS_DMA_
__eds__ int ADC1BufferA[3] __attribute__((eds,space(dma)));
__eds__ int ADC1BufferB[3] __attribute__((eds,space(dma)));
#else
  int ADC1BufferA[3] __attribute__((space(xmemory)));
  int ADC1BufferB[3] __attribute__((space(xmemory)));
#endif


/******************************************************************************/
/* Main Program                                                               */
/******************************************************************************/

int ADCValues[3] = {0, 0, 0}; // ADC 10 bits  AN0, AN1 and AN3;

int eCAN_cnt =0; /*  Contador eCAN  */
unsigned int ControlDutyCycle=0;

// #include <libq.h> /* include fixed point library */
int VsinQ15[668] = {
 0x0000, 0x0135, 0x0269, 0x039e, 0x04d2, 0x0607, 0x073b, 0x086f, 0x09a3, 0x0ad7,
 0x0c0a, 0x0d3d, 0x0e70, 0x0fa3, 0x10d5, 0x1207, 0x1338, 0x1469, 0x159a, 0x16ca,
 0x17f9, 0x1928, 0x1a56, 0x1b84, 0x1cb1, 0x1dde, 0x1f0a, 0x2035, 0x215f, 0x2289,
 0x23b2, 0x24da, 0x2601, 0x2727, 0x284c, 0x2971, 0x2a95, 0x2bb7, 0x2cd9, 0x2df9,
 0x2f19, 0x3037, 0x3155, 0x3271, 0x338c, 0x34a6, 0x35bf, 0x36d6, 0x37ed, 0x3902,
 0x3a15, 0x3b28, 0x3c39, 0x3d49, 0x3e57, 0x3f64, 0x406f, 0x4179, 0x4282, 0x4389,
 0x448e, 0x4592, 0x4694, 0x4795, 0x4894, 0x4992, 0x4a8d, 0x4b87, 0x4c80, 0x4d76,
 0x4e6b, 0x4f5e, 0x5050, 0x513f, 0x522d, 0x5318, 0x5402, 0x54ea, 0x55d0, 0x56b4,
 0x5796, 0x5876, 0x5954, 0x5a30, 0x5b0a, 0x5be2, 0x5cb8, 0x5d8c, 0x5e5e, 0x5f2d,
 0x5ffa, 0x60c6, 0x618f, 0x6255, 0x631a, 0x63dc, 0x649c, 0x655a, 0x6615, 0x66ce,
 0x6785, 0x6839, 0x68eb, 0x699b, 0x6a48, 0x6af3, 0x6b9b, 0x6c41, 0x6ce5, 0x6d86,
 0x6e24, 0x6ec0, 0x6f5a, 0x6ff1, 0x7085, 0x7117, 0x71a6, 0x7233, 0x72bd, 0x7345,
 0x73c9, 0x744c, 0x74cb, 0x7548, 0x75c3, 0x763a, 0x76af, 0x7721, 0x7791, 0x77fe,
 0x7868, 0x78cf, 0x7934, 0x7996, 0x79f5, 0x7a51, 0x7aab, 0x7b02, 0x7b56, 0x7ba7,
 0x7bf5, 0x7c41, 0x7c89, 0x7ccf, 0x7d12, 0x7d53, 0x7d90, 0x7dcb, 0x7e02, 0x7e37,
 0x7e69, 0x7e98, 0x7ec4, 0x7eee, 0x7f14, 0x7f37, 0x7f58, 0x7f76, 0x7f91, 0x7fa9,
 0x7fbe, 0x7fd0, 0x7fdf, 0x7fec, 0x7ff5, 0x7ffc, 0x7fff, 0x7fff, 0x7ffe, 0x7ff9,
 0x7ff1, 0x7fe6, 0x7fd8, 0x7fc7, 0x7fb4, 0x7f9d, 0x7f84, 0x7f67, 0x7f48, 0x7f26,
 0x7f01, 0x7ed9, 0x7eae, 0x7e81, 0x7e50, 0x7e1d, 0x7de7, 0x7dae, 0x7d72, 0x7d33,
 0x7cf1, 0x7cad, 0x7c65, 0x7c1b, 0x7bce, 0x7b7f, 0x7b2c, 0x7ad7, 0x7a7e, 0x7a23,
 0x79c6, 0x7965, 0x7902, 0x789c, 0x7833, 0x77c8, 0x775a, 0x76e9, 0x7675, 0x75ff,
 0x7586, 0x750a, 0x748c, 0x740b, 0x7387, 0x7301, 0x7278, 0x71ed, 0x715f, 0x70ce,
 0x703b, 0x6fa5, 0x6f0d, 0x6e72, 0x6dd5, 0x6d35, 0x6c93, 0x6bee, 0x6b47, 0x6a9e,
 0x69f2, 0x6943, 0x6892, 0x67df, 0x672a, 0x6672, 0x65b8, 0x64fb, 0x643c, 0x637b,
 0x62b8, 0x61f2, 0x612a, 0x6060, 0x5f94, 0x5ec6, 0x5df5, 0x5d22, 0x5c4e, 0x5b77,
 0x5a9e, 0x59c3, 0x58e6, 0x5807, 0x5725, 0x5642, 0x555d, 0x5476, 0x538d, 0x52a3,
 0x51b6, 0x50c7, 0x4fd7, 0x4ee5, 0x4df1, 0x4cfb, 0x4c04, 0x4b0b, 0x4a10, 0x4913,
 0x4815, 0x4715, 0x4613, 0x4510, 0x440c, 0x4305, 0x41fe, 0x40f4, 0x3fea, 0x3ede,
 0x3dd0, 0x3cc1, 0x3bb1, 0x3a9f, 0x398c, 0x3877, 0x3762, 0x364b, 0x3533, 0x3419,
 0x32ff, 0x31e3, 0x30c6, 0x2fa8, 0x2e89, 0x2d69, 0x2c48, 0x2b26, 0x2a03, 0x28df,
 0x27ba, 0x2694, 0x256d, 0x2446, 0x231d, 0x21f4, 0x20ca, 0x1f9f, 0x1e74, 0x1d48,
 0x1c1b, 0x1aed, 0x19bf, 0x1891, 0x1761, 0x1632, 0x1501, 0x13d1, 0x12a0, 0x116e,
 0x103c, 0x0f0a, 0x0dd7, 0x0ca4, 0x0b71, 0x0a3d, 0x0909, 0x07d5, 0x06a1, 0x056d,
 0x0438, 0x0304, 0x01cf, 0x009a, 0xff66, 0xfe31, 0xfcfc, 0xfbc8, 0xfa93, 0xf95f,
 0xf82b, 0xf6f7, 0xf5c3, 0xf48f, 0xf35c, 0xf229, 0xf0f6, 0xefc4, 0xee92, 0xed60,
 0xec2f, 0xeaff, 0xe9ce, 0xe89f, 0xe76f, 0xe641, 0xe513, 0xe3e5, 0xe2b8, 0xe18c,
 0xe061, 0xdf36, 0xde0c, 0xdce3, 0xdbba, 0xda93, 0xd96c, 0xd846, 0xd721, 0xd5fd,
 0xd4da, 0xd3b8, 0xd297, 0xd177, 0xd058, 0xcf3a, 0xce1d, 0xcd01, 0xcbe7, 0xcacd,
 0xc9b5, 0xc89e, 0xc789, 0xc674, 0xc561, 0xc44f, 0xc33f, 0xc230, 0xc122, 0xc016,
 0xbf0c, 0xbe02, 0xbcfb, 0xbbf4, 0xbaf0, 0xb9ed, 0xb8eb, 0xb7eb, 0xb6ed, 0xb5f0,
 0xb4f5, 0xb3fc, 0xb305, 0xb20f, 0xb11b, 0xb029, 0xaf39, 0xae4a, 0xad5d, 0xac73,
 0xab8a, 0xaaa3, 0xa9be, 0xa8db, 0xa7f9, 0xa71a, 0xa63d, 0xa562, 0xa489, 0xa3b2,
 0xa2de, 0xa20b, 0xa13a, 0xa06c, 0x9fa0, 0x9ed6, 0x9e0e, 0x9d48, 0x9c85, 0x9bc4,
 0x9b05, 0x9a48, 0x998e, 0x98d6, 0x9821, 0x976e, 0x96bd, 0x960e, 0x9562, 0x94b9,
 0x9412, 0x936d, 0x92cb, 0x922b, 0x918e, 0x90f3, 0x905b, 0x8fc5, 0x8f32, 0x8ea1,
 0x8e13, 0x8d88, 0x8cff, 0x8c79, 0x8bf5, 0x8b74, 0x8af6, 0x8a7a, 0x8a01, 0x898b,
 0x8917, 0x88a6, 0x8838, 0x87cd, 0x8764, 0x86fe, 0x869b, 0x863a, 0x85dd, 0x8582,
 0x8529, 0x84d4, 0x8481, 0x8432, 0x83e5, 0x839b, 0x8353, 0x830f, 0x82cd, 0x828e,
 0x8252, 0x8219, 0x81e3, 0x81b0, 0x817f, 0x8152, 0x8127, 0x80ff, 0x80da, 0x80b8,
 0x8099, 0x807c, 0x8063, 0x804c, 0x8039, 0x8028, 0x801a, 0x800f, 0x8007, 0x8002,
 0x8000, 0x8001, 0x8004, 0x800b, 0x8014, 0x8021, 0x8030, 0x8042, 0x8057, 0x806f,
 0x808a, 0x80a8, 0x80c9, 0x80ec, 0x8112, 0x813c, 0x8168, 0x8197, 0x81c9, 0x81fe,
 0x8235, 0x8270, 0x82ad, 0x82ee, 0x8331, 0x8377, 0x83bf, 0x840b, 0x8459, 0x84aa,
 0x84fe, 0x8555, 0x85af, 0x860b, 0x866a, 0x86cc, 0x8731, 0x8798, 0x8802, 0x886f,
 0x88df, 0x8951, 0x89c6, 0x8a3d, 0x8ab8, 0x8b35, 0x8bb4, 0x8c37, 0x8cbb, 0x8d43,
 0x8dcd, 0x8e5a, 0x8ee9, 0x8f7b, 0x900f, 0x90a6, 0x9140, 0x91dc, 0x927a, 0x931b,
 0x93bf, 0x9465, 0x950d, 0x95b8, 0x9665, 0x9715, 0x97c7, 0x987b, 0x9932, 0x99eb,
 0x9aa6, 0x9b64, 0x9c24, 0x9ce6, 0x9dab, 0x9e71, 0x9f3a, 0xa006, 0xa0d3, 0xa1a2,
 0xa274, 0xa348, 0xa41e, 0xa4f6, 0xa5d0, 0xa6ac, 0xa78a, 0xa86a, 0xa94c, 0xaa30,
 0xab16, 0xabfe, 0xace8, 0xadd3, 0xaec1, 0xafb0, 0xb0a2, 0xb195, 0xb28a, 0xb380,
 0xb479, 0xb573, 0xb66e, 0xb76c, 0xb86b, 0xb96c, 0xba6e, 0xbb72, 0xbc77, 0xbd7e,
 0xbe87, 0xbf91, 0xc09c, 0xc1a9, 0xc2b7, 0xc3c7, 0xc4d8, 0xc5eb, 0xc6fe, 0xc813,
 0xc92a, 0xca41, 0xcb5a, 0xcc74, 0xcd8f, 0xceab, 0xcfc9, 0xd0e7, 0xd207, 0xd327,
 0xd449, 0xd56b, 0xd68f, 0xd7b4, 0xd8d9, 0xd9ff, 0xdb26, 0xdc4e, 0xdd77, 0xdea1,
 0xdfcb, 0xe0f6, 0xe222, 0xe34f, 0xe47c, 0xe5aa, 0xe6d8, 0xe807, 0xe936, 0xea66,
 0xeb97, 0xecc8, 0xedf9, 0xef2b, 0xf05d, 0xf190, 0xf2c3, 0xf3f6, 0xf529, 0xf65d,
 0xf791, 0xf8c5, 0xf9f9, 0xfb2e, 0xfc62, 0xfd97, 0xfecb};


int main(void)
{
    
    /* Configure the oscillator for the device */
    ConfigureOscillator();

    /* Initialize IO ports and peripherals */
    InitIO();    

    INTx_IO_Init();  /* Initialize Pins Interrupts  */
    /* TODO <INSERT USER APPLICATION CODE HERE> */

    initeCAN();   /*      */

    initDMAch0CANTx();   /*   */
    initDMAch1CANRx();   /*   */
 //   initDMAch2ADC1();    /*   */

//#if defined(__PROTOTIPO__)
    initADC1();
  //  initADC1DMAch2();    /*     */
    initTMR3();          /*     */
 //#endif

       
#if defined(__MASTER__)
/* Configura��o para opera��o como Mestre */
     initPWM_Master();


/* configure and send a message */
	canTxMessage.message_type=CAN_MSG_DATA;
	//canTxMessage.message_type=CAN_MSG_RTR;
	//canTxMessage.frame_type=CAN_FRAME_EXT;
	canTxMessage.frame_type=CAN_FRAME_STD;
	canTxMessage.buffer=0;
	canTxMessage.id=0x123;
	canTxMessage.data_length=4;
        canTxMessage.data_word[0]=0x00;
        canTxMessage.data_word[1]=0x00;

        /* get the SID */
  //    ecan1msgBuf[0][0]=((canTxMessage.id & 0x000007FF) << 2);;
  //    ecan1msgBuf[0][1]=0;
  //    ecan1msgBuf[0][2]=(canTxMessage.data_length & 0x0F);

    
#elif defined(__SLAVE__)
/* Configura��o para Opera��o como Escravo */
     initPWM_Slave();
     initPTG();

/* configure and send a message */
	canTxMessage.message_type=CAN_MSG_DATA;
	canTxMessage.frame_type=CAN_FRAME_STD;
	canTxMessage.buffer=0;
	canTxMessage.id=0x125;
	canTxMessage.data_length=4;
        canTxMessage.data_word[0]=0x00;
        canTxMessage.data_word[1]=0x00;
          
#endif
   

    while(1)
    {


                
    }


}
